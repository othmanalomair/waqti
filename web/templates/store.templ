package templates

import (
	"fmt"
	"strings"
	"waqti/internal/models"
)

templ StorePage(creator *models.Creator, workshops []models.Workshop, settings *models.ShopSettings, lang string, isRTL bool) {
	<!DOCTYPE html>
	<html lang={ lang } dir={ getDirection(isRTL) }>
	<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<title>
			if lang == "ar" {
				{ getSettingsCreatorName(settings, lang) } - Waqti.me
			} else {
				{ getSettingsCreatorName(settings, lang) } - Waqti.me
			}
		</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link rel="preconnect" href="https://fonts.googleapis.com"/>
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap"/>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"/>

		<script>
			tailwind.config = {
				theme: {
					extend: {
						colors: {
							'gulf-teal': '#2DD4BF',
							'ivory-sand': '#FEFCE8',
							'slate-charcoal': '#1E293B'
						},
						fontFamily: {
							'cairo': ['Cairo', 'sans-serif'],
							'inter': ['Inter', 'sans-serif']
						}
					}
				}
			}
		</script>

		<style>
			.font-primary {
				font-family: { getFontFamily(isRTL) };
			}

			.store-gradient {
				background: linear-gradient(135deg, #F0FDFA 0%, #FEFCE8 100%);
			}

			.course-card {
				background: rgba(255, 255, 255, 0.9);
				backdrop-filter: blur(10px);
				border: 1px solid rgba(45, 212, 191, 0.1);
				transition: all 0.3s ease;
			}

			.course-card:hover {
				transform: translateY(-2px);
				box-shadow: 0 10px 30px rgba(45, 212, 191, 0.15);
				border-color: rgba(45, 212, 191, 0.3);
			}

			.cart-button {
				background: linear-gradient(135deg, #2DD4BF 0%, #06B6D4 100%);
				transition: all 0.3s ease;
			}

			.cart-button:hover {
				transform: translateY(-1px);
				box-shadow: 0 8px 25px rgba(45, 212, 191, 0.3);
			}

			.cart-badge {
				background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
				animation: pulse 1s infinite;
			}

			/* Session Selection Styles */
			.session-radio:checked ~ .radio-dot {
				opacity: 1;
			}

			.session-radio:checked ~ * label {
				border-color: #2DD4BF;
			}

			label:has(.session-radio:checked) {
				border-color: #2DD4BF !important;
			}

			label:has(.session-radio:checked) .radio-dot {
				opacity: 1;
			}

			.whatsapp-button {
				background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
				transition: all 0.3s ease;
			}

			.whatsapp-button:hover {
				transform: translateY(-2px);
				box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);
			}

			@keyframes pulse {
				0%, 100% { transform: scale(1); }
				50% { transform: scale(1.05); }
			}

			.course-image {
				transition: opacity 0.3s ease-in-out;
			}

			.image-indicator.active {
				background-color: white !important;
				transform: scale(1.2);
			}

			.carousel-nav-button {
				opacity: 0.7;
				transition: all 0.3s ease;
			}

			.carousel-nav-button:hover {
				opacity: 1;
				transform: translateY(-50%) scale(1.1);
			}
		</style>
	</head>
	<body class="font-primary store-gradient min-h-screen">

		<!-- Header -->
		<header class="bg-white/80 backdrop-blur-md border-b border-gulf-teal/10 sticky top-0 z-40">
			<div class="max-w-6xl mx-auto px-4 py-4">
				<div class="flex items-center justify-between">
					<!-- Creator Info -->
					<div class="flex items-center space-x-3 flex-1 min-w-0">
						<img
							src={ settings.LogoURL }
							alt={ getSettingsCreatorName(settings, lang) }
							class="w-12 h-12 md:w-14 md:h-14 rounded-full object-cover border-2 border-gulf-teal/20 flex-shrink-0"
							onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMyREQ0QkYiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPgo8cGF0aCBkPSJNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTRzLTEuNzktNC00LTQtNCAxLjc5LTQgNCAxLjc5IDQgNCA0em0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djJoMTZ2LTJjMC0yLjY2LTUuMzMtNC04LTR6Ii8+Cjwvc3ZnPgo8L3N2Zz4K'"
						/>
						<div class="min-w-0 flex-1">
							<h1 class="text-lg md:text-xl font-bold text-slate-charcoal truncate">
								{ getSettingsCreatorName(settings, lang) }
							</h1>
							<p class="text-sm text-gray-600 truncate hidden sm:block">
								{ getSettingsDescription(settings, lang) }
							</p>
						</div>
					</div>

					<!-- Language Toggle & Cart -->
					<div class="flex items-center space-x-3 flex-shrink-0">
						<form method="POST" action="/toggle-language">
							<input type="hidden" name="redirect_to" value={ fmt.Sprintf("/%s", creator.Username) }/>
							<button type="submit" class="flex items-center space-x-1 px-3 py-2 bg-white/50 rounded-lg border border-gray-200 hover:bg-white transition-colors">
								<span class="text-sm font-medium">
									if lang == "ar" {
										EN
									} else {
										عربي
									}
								</span>
							</button>
						</form>

						<!-- Cart Icon -->
						<button
							onclick="toggleCart(true)"
							class="relative p-2 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors"
						>
							<svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
								<path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
							</svg>
							<span
								class="cart-badge absolute -top-2 -right-2 w-5 h-5 text-white text-xs rounded-full flex items-center justify-center font-medium"
								style="display: none;"
							></span>
						</button>
					</div>
				</div>
			</div>
		</header>

		<!-- Creator Description -->
		if getSettingsDescription(settings, lang) != "" {
			<section class="max-w-4xl mx-auto px-4 py-6">
				<div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 border border-gulf-teal/10">
					<p class="text-gray-700 leading-relaxed text-center text-sm md:text-base">
						{ getSettingsDescription(settings, lang) }
					</p>
				</div>
			</section>
		}

		<!-- Courses Grid -->
		<section class="max-w-6xl mx-auto px-4 pb-20">
			<h2 class="text-2xl font-bold text-slate-charcoal mb-8 text-center">
				if lang == "ar" {
					الدورات المتاحة
				} else {
					Available Courses
				}
			</h2>

			if len(workshops) > 0 {
				<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
					for _, workshop := range workshops {
						if workshop.IsActive {
							@CourseCard(workshop, lang)
						}
					}
				</div>
			} else {
				<div class="text-center py-16">
					<svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 24 24">
						<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
					</svg>
					<h3 class="text-lg font-semibold text-gray-500 mb-2">
						if lang == "ar" {
							لا توجد دورات متاحة حالياً
						} else {
							No courses available yet
						}
					</h3>
					<p class="text-gray-400">
						if lang == "ar" {
							تابعنا للحصول على إشعارات حول الدورات الجديدة
						} else {
							Follow us for updates on new courses
						}
					</p>
				</div>
			}
		</section>

		<!-- Floating WhatsApp Button -->
		<div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50">
			<button
				onclick="proceedToWhatsApp()"
				class="whatsapp-button text-white px-6 py-3 rounded-full font-semibold flex items-center space-x-2 shadow-lg"
			>
				<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
					<path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.488"/>
				</svg>
				<span id="whatsapp-text">
					if lang == "ar" {
						تواصل معنا
					} else {
						Contact Us
					}
				</span>
			</button>
		</div>

		<!-- Cart Modal -->
		<div
			id="cart-modal"
			class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
			style="display: none;"
			onclick="if (event.target === this) toggleCart(false)"
		>
			<div class="bg-white rounded-2xl max-w-md w-full max-h-96 overflow-y-auto">
				<div class="p-6">
					<div class="flex items-center justify-between mb-4">
						<h3 class="text-lg font-bold text-slate-charcoal">
							if lang == "ar" {
								سلة التسوق
							} else {
								Shopping Cart
							}
						</h3>
						<button onclick="toggleCart(false)" class="text-gray-400 hover:text-gray-600">
							<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
								<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
							</svg>
						</button>
					</div>

					<div id="empty-cart" class="text-center py-8">
						<svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="currentColor" viewBox="0 0 24 24">
							<path d="M7 4V2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v2h4a1 1 0 0 1 0 2h-1l-.867 12.142A2 2 0 0 1 17.135 20H6.865a2 2 0 0 1-1.998-1.858L4 6H3a1 1 0 0 1 0-2h4zM9 4h6V3H9v1z"/>
						</svg>
						<p class="text-gray-500">
							if lang == "ar" {
								سلة التسوق فارغة
							} else {
								Your cart is empty
							}
						</p>
					</div>

					<div id="cart-items" style="display: none;">
						<div id="items-container" class="space-y-4"></div>
						<div class="border-t pt-4">
							<div class="flex justify-between items-center mb-4">
								<span class="font-bold">
									if lang == "ar" {
										المجموع:
									} else {
										Total:
									}
								</span>
								<span id="total-price" class="font-bold text-gulf-teal text-lg">0.00 KD</span>
							</div>
							<button
								onclick="proceedToWhatsApp()"
								class="whatsapp-button w-full text-white py-3 rounded-xl font-semibold"
							>
								if lang == "ar" {
									اطلب عبر واتساب
								} else {
									Order via WhatsApp
								}
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Store JavaScript -->
		<!-- Hidden divs to store template data -->
		<div id="creator-name" style="display: none;">{ getSettingsCreatorName(settings, lang) }</div>
		<div id="creator-username" style="display: none;">{ creator.Username }</div>
		<div id="contact-whatsapp" style="display: none;">{ settings.ContactWhatsApp }</div>
		<div id="greeting-message" style="display: none;">
			if lang == "ar" {
				{ settings.GreetingMessageAr }
			} else {
				{ settings.GreetingMessage }
			}
		</div>
		<script>
			// Global store state
			let cart = [];
			let showCart = false;

			// Initialize store on page load
			document.addEventListener('DOMContentLoaded', function() {
				const courseCards = document.querySelectorAll('.course-card');
				courseCards.forEach(initializeCourseCard);

				// Add event delegation for image indicators
				document.addEventListener('click', function(e) {
					if (e.target.classList.contains('image-indicator')) {
						const index = parseInt(e.target.dataset.imageIndex);
						setCurrentImage(e.target, index);
					}
				});

				// Listen for add-to-cart events from course cards
				window.addEventListener('add-to-cart', function(event) {
					handleAddToCart(event.detail);
				});

				updateCartDisplay();
			});

			function initializeCourseCard(card) {
				// Find cover image or default to first image
				const images = card.querySelectorAll('.course-image');
				let coverImageIndex = 0;

				// Look for an image with IsCover = true
				images.forEach((img, index) => {
					if (img.dataset.isCover === 'true') {
						coverImageIndex = index;
					}
				});

				card.currentImageIndex = coverImageIndex;
				card.quantity = 1;

				// Show the cover image first
				updateImageDisplay(card);
				updateQuantityDisplay(card);
				updateAddToCartButton(card);
			}

			function handleAddToCart(cartItem) {
				const existingItem = cart.find(item => item.id === cartItem.id && item.sessionId === cartItem.sessionId);
				if (existingItem) {
					existingItem.quantity += cartItem.quantity;
				} else {
					cart.push({...cartItem});
				}

				updateCartDisplay();
				// Don't automatically show cart modal
			}

			function toggleCart(show) {
				showCart = show;
				const cartModal = document.getElementById('cart-modal');
				if (cartModal) {
					cartModal.style.display = showCart ? 'flex' : 'none';
				}
				updateCartContent();
			}

			function getTotalItems() {
				return cart.reduce((total, item) => total + (item.quantity || 1), 0);
			}

			function getTotalPrice() {
				return cart.reduce((total, item) => total + (parseFloat(item.price) * (item.quantity || 1)), 0).toFixed(2);
			}

			function updateCartDisplay() {
				// Update cart badge
				const cartBadge = document.querySelector('.cart-badge');
				const totalItems = getTotalItems();
				if (cartBadge) {
					cartBadge.style.display = totalItems > 0 ? 'flex' : 'none';
					cartBadge.textContent = totalItems;
				}

				// Update WhatsApp button text
				const whatsappText = document.getElementById('whatsapp-text');
				if (whatsappText) {
					if (totalItems > 0) {
						whatsappText.textContent = totalItems + (document.documentElement.lang === 'ar' ? ' اطلب عبر واتساب' : ' Order via WhatsApp');
					} else {
						whatsappText.textContent = document.documentElement.lang === 'ar' ? 'تواصل معنا' : 'Contact Us';
					}
				}
			}

			function updateCartContent() {
				const emptyCart = document.getElementById('empty-cart');
				const cartItems = document.getElementById('cart-items');
				const itemsContainer = document.getElementById('items-container');
				const totalPrice = document.getElementById('total-price');

				if (cart.length === 0) {
					if (emptyCart) emptyCart.style.display = 'block';
					if (cartItems) cartItems.style.display = 'none';
				} else {
					if (emptyCart) emptyCart.style.display = 'none';
					if (cartItems) {
						cartItems.style.display = 'block';
						updateCartItemsHTML(itemsContainer);
					}
				}

				// Update total price
				if (totalPrice) {
					totalPrice.textContent = getTotalPrice() + ' KD';
				}
			}

			function updateCartItemsHTML(container) {
				if (!container) return;

				const lang = document.documentElement.lang;
				const isRTL = lang === 'ar';

				container.innerHTML = cart.map(item => `
					<div class="relative p-3 bg-gray-50 rounded-lg">
						<button onclick="removeFromCart('${item.id}')" class="absolute ${isRTL ? 'top-2 left-2' : 'top-2 right-2'} text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50 transition-colors">
							<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
								<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
							</svg>
						</button>
						<div class="${isRTL ? 'pl-8' : 'pr-8'}">
							<h4 class="font-semibold text-sm truncate">${item.title}</h4>
							<div class="flex items-center justify-between mt-1">
								<p class="text-gulf-teal font-bold">${(item.price * item.quantity).toFixed(2)} KD</p>
								<span class="text-xs text-gray-500">Qty: ${item.quantity}</span>
							</div>
						</div>
					</div>
				`).join('');
			}

			function removeFromCart(itemId) {
				cart = cart.filter(item => item.id !== itemId);
				updateCartDisplay();
				updateCartContent();
			}


			// Generate unique request number
			function generateRequestNumber() {
				return 'REQ' + Date.now().toString().slice(-6);
			}

			// Get session details for display
			function getSessionDetails(sessionId, lang) {
				if (!sessionId) return lang === 'ar' ? 'غير محدد' : 'Not specified';

				// Find session in DOM
				const sessionRadio = document.querySelector(`input[value="${sessionId}"]`);
				if (sessionRadio) {
					const sessionLabel = sessionRadio.closest('label');
					const sessionText = sessionLabel.querySelector('.font-medium').textContent;
					const timeText = sessionLabel.querySelector('.text-xs.text-gray-600').textContent;
					return `${sessionText}\n${timeText}`;
				}
				return sessionId;
			}

			// Get session number for WhatsApp message
			function getSessionNumber(sessionId) {
				if (!sessionId) return '';

				const sessionRadio = document.querySelector(`input[value="${sessionId}"]`);
				if (sessionRadio) {
					const sessionLabel = sessionRadio.closest('label');
					const sessionTitleElement = sessionLabel.querySelector('.font-medium');
					if (sessionTitleElement) {
						const sessionTitle = sessionTitleElement.textContent;
						// Extract session number from text like "Session 1:", "Session 2:", etc.
						const sessionMatch = sessionTitle.match(/(?:Session|جلسة)\s*(\d+)/i);
						if (sessionMatch) {
							return sessionMatch[1];
						}
					}
				}
				return '1'; // default to 1 if not found
			}

			// Format session details for WhatsApp message
			function formatSessionForWhatsApp(sessionId, lang) {
				if (!sessionId) return lang === 'ar' ? 'غير محدد' : 'Not specified';

				// Find session in DOM
				const sessionRadio = document.querySelector(`input[value="${sessionId}"]`);
				if (sessionRadio) {
					// Get data directly from data attributes (much more reliable!)
					const sessionDatesCount = parseInt(sessionRadio.dataset.sessionDatesCount) || 0;
					const workshopType = sessionRadio.dataset.workshopType || 'single';
					const startTime = sessionRadio.dataset.startTime;
					const endTime = sessionRadio.dataset.endTime;
					const sessionDate = sessionRadio.dataset.sessionDate;
					const sessionDates = sessionRadio.dataset.sessionDates;

					console.log('Session data:', {
						sessionDatesCount,
						workshopType,
						startTime,
						endTime,
						sessionDate,
						sessionDates
					});

					let formattedSessions = '';

					// Format start and end times using the same logic as formatSessionTime helper
					function formatTime(timeStr) {
						if (!timeStr || timeStr === 'TBD') return 'Time TBD';

						// Handle ISO format dates (like "0000-01-01T20:00:00Z")
						if (timeStr.includes('T')) {
							const timePart = timeStr.split('T')[1];
							if (timePart) {
								timeStr = timePart.split('Z')[0]; // Remove Z if present
							}
						}

						// Remove any timezone info or extra characters
						timeStr = timeStr.trim();

						// Parse the time string (format: "15:04:05" or "15:04")
						if (timeStr.length >= 5) {
							// Extract hours and minutes
							const hours = timeStr.substring(0, 2);
							const minutes = timeStr.substring(3, 5);

							// Convert to 12-hour format
							let hour = parseInt(hours);
							if (isNaN(hour) || hour < 0 || hour > 23) {
								return timeStr; // Return original if parsing fails
							}

							const ampm = hour >= 12 ? 'PM' : 'AM';
							let displayHour = hour;
							if (hour >= 12) {
								if (hour > 12) {
									displayHour = hour - 12;
								}
							}
							if (displayHour === 0) {
								displayHour = 12;
							}

							return `${displayHour}:${minutes} ${ampm}`;
						}
						return timeStr;
					}

					const formattedStartTime = formatTime(startTime);
					const formattedEndTime = formatTime(endTime);

					let timeRange = formattedStartTime;
					if (formattedEndTime && formattedEndTime !== formattedStartTime && !formattedEndTime.includes('TBD')) {
						timeRange += ' to ' + formattedEndTime;
					}

					// Handle different workshop types
					if (workshopType === 'consecutive' && sessionDatesCount > 1 && sessionDates) {
						// Consecutive: show as "X days\nstart till end, weekday, time"
						const dates = sessionDates.split('|');
						if (dates.length >= 2) {
							const startDate = new Date(dates[0]);
							const endDate = new Date(dates[dates.length - 1]);

							if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
								const startDay = startDate.getDate();
								const startMonth = startDate.toLocaleDateString('en-US', { month: 'short' });
								const endDay = endDate.getDate();
								const endMonth = endDate.toLocaleDateString('en-US', { month: 'short' });
								const dayName = startDate.toLocaleDateString('en-US', { weekday: 'short' });

								formattedSessions = `${sessionDatesCount} days\n${startDay} / ${startMonth} till ${endDay} / ${endMonth}, ${dayName}`;
								if (timeRange) {
									formattedSessions += `, ${timeRange}`;
								}
							}
						}
					}
					else if ((workshopType === 'spread' || workshopType === 'custom') && sessionDates) {
						// Spread/Custom: show each date on separate line
						const dates = sessionDates.split('|');
						dates.forEach(dateStr => {
							const date = new Date(dateStr);
							if (!isNaN(date.getTime())) {
								const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
								const dayNum = date.getDate();
								const month = date.toLocaleDateString('en-US', { month: 'short' });

								let line = `${dayNum} / ${month}, ${dayName}`;
								if (timeRange) {
									line += `, ${timeRange}`;
								}
								formattedSessions += line + '\n';
							}
						});
						formattedSessions = formattedSessions.trim();
					}
					else {
						// Single day or fallback
						const date = new Date(sessionDate);
						if (!isNaN(date.getTime())) {
							const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
							const dayNum = date.getDate();
							const month = date.toLocaleDateString('en-US', { month: 'short' });

							formattedSessions = `${dayNum} / ${month}, ${dayName}`;
							if (timeRange) {
								formattedSessions += `, ${timeRange}`;
							}
						}
					}

					return formattedSessions;
				}
				return sessionId;
			}

			// Group cart items by workshop+session combination
			function groupCartItems(cart) {
				const grouped = {};

				cart.forEach(item => {
					const key = `${item.id}-${item.sessionId || 'no-session'}`;
					if (grouped[key]) {
						grouped[key].totalQuantity += item.quantity;
					} else {
						grouped[key] = {
							id: item.id,
							title: item.title,
							price: item.price,
							sessionId: item.sessionId,
							totalQuantity: item.quantity,
							image: item.image
						};
					}
				});

				return Object.values(grouped);
			}

			async function proceedToWhatsApp() {
				const creatorName = document.getElementById('creator-name').textContent;
				const creatorUsername = document.getElementById('creator-username').textContent;
				const contactWhatsApp = document.getElementById('contact-whatsapp').textContent;
				const greetingMessage = document.getElementById('greeting-message').textContent.trim();
				let message = '';

				if (cart.length > 0) {
					// Create order in database first and get customer info
					let customerInfo;
					try {
						customerInfo = await createOrderInDatabase();
						if (!customerInfo) {
							// Customer cancelled, just return without error
							return;
						}
					} catch (error) {
						console.error('Failed to create order:', error);
						alert('Failed to create order. Please try again.');
						return;
					}

					const requestNumber = generateRequestNumber();
					const lang = document.documentElement.lang;

					// Group cart items by workshop+session combination
					const groupedItems = groupCartItems(cart);

					if (lang === 'ar') {
						message = `رقم الطلب: ${requestNumber}\n\n\nمرحباً، أنا ${customerInfo.name}\n`;
						if (greetingMessage) {
							message += `${greetingMessage}\n\n`;
						}
						groupedItems.forEach((group) => {
							const sessionNumber = getSessionNumber(group.sessionId);
							const sessionDetails = formatSessionForWhatsApp(group.sessionId, lang);

							// Get workshop type from session data
							let workshopType = 'single';
							if (group.sessionId) {
								const sessionRadio = document.querySelector(`input[value="${group.sessionId}"]`);
								if (sessionRadio) {
									workshopType = sessionRadio.dataset.workshopType || 'single';
								}
							}

							message += `اسم الورشة: ${group.title}\n`;
							if (workshopType !== 'private') {
								message += `جلسة ${sessionNumber}\n`;
								message += `${sessionDetails}\n`;
							}
							message += `عدد المقاعد: ${group.totalQuantity}\n`;
							message += `السعر: ${(group.price * group.totalQuantity).toFixed(2)} د.ك\n\n`;
						});
						message += `إجمالي السعر: ${getTotalPrice()} د.ك`;
					} else {
						message = `Request number: ${requestNumber}\n\n\nHello, I am ${customerInfo.name}\n`;
						if (greetingMessage) {
							message += `${greetingMessage}\n\n`;
						}
						groupedItems.forEach((group) => {
							const sessionNumber = getSessionNumber(group.sessionId);
							const sessionDetails = formatSessionForWhatsApp(group.sessionId, lang);

							// Get workshop type from session data
							let workshopType = 'single';
							if (group.sessionId) {
								const sessionRadio = document.querySelector(`input[value="${group.sessionId}"]`);
								if (sessionRadio) {
									workshopType = sessionRadio.dataset.workshopType || 'single';
								}
							}

							message += `Workshop name: ${group.title}\n`;
							if (workshopType !== 'private') {
								message += `Session ${sessionNumber}\n`;
								message += `${sessionDetails}\n`;
							}
							message += `Number of seats: ${group.totalQuantity}\n`;
							message += `Price: ${(group.price * group.totalQuantity).toFixed(2)} KD\n\n`;
						});
						message += `Total price: ${getTotalPrice()} KD`;
					}
				} else {
					if (document.documentElement.lang === 'ar') {
						message = `مرحباً ${creatorName}، أريد الاستفسار عن الدورات المتاحة.`;
					} else {
						message = `Hello ${creatorName}, I would like to inquire about available courses.`;
					}
				}

				// Clean phone number and construct WhatsApp URL
				if (!contactWhatsApp || contactWhatsApp.trim() === '') {
					alert(document.documentElement.lang === 'ar' ? 'رقم واتساب غير متوفر' : 'WhatsApp number not available');
					return;
				}
				const cleanPhone = contactWhatsApp.replace(/[^\d]/g, '');
				console.log('Raw WhatsApp:', contactWhatsApp, 'Clean:', cleanPhone, 'Length:', cleanPhone.length);
				if (!cleanPhone || cleanPhone.length < 8) {
					alert((document.documentElement.lang === 'ar' ? 'رقم واتساب غير صحيح: ' : 'Invalid WhatsApp number: ') + cleanPhone + ' (length: ' + cleanPhone.length + ')');
					return;
				}
				const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
				window.open(whatsappUrl, '_blank');

				// Clear cart after sending
				if (cart.length > 0) {
					cart = [];
					updateCartDisplay();
					updateCartContent();
					toggleCart(false);
				}
			}

			async function createOrderInDatabase() {
				if (cart.length === 0) return;

				// Show customer info dialog
				const customerInfo = await showCustomerInfoDialog();
				if (!customerInfo) {
					// Customer cancelled, return null without error
					return null;
				}

				// Prepare order data
				const orderData = {
					customer_name: customerInfo.name,
					customer_phone: customerInfo.phone,
					order_source: 'whatsapp',
					creator_username: document.getElementById('creator-username').textContent,
					items: cart.map(item => ({
						workshop_id: item.id,
						session_id: item.sessionId || null,
						quantity: item.quantity
					}))
				};

				// Send order to API
				const response = await fetch('/api/orders', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(orderData)
				});

				if (!response.ok) {
					const error = await response.json();
					throw new Error(error.error || 'Failed to create order');
				}

				const result = await response.json();
				console.log('Order created successfully:', result);
				return customerInfo;
			}

			function showCustomerInfoDialog() {
				return new Promise((resolve) => {
					const lang = document.documentElement.lang;
					const isRTL = lang === 'ar';

					// Create modal HTML
					const modal = document.createElement('div');
					modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
					modal.innerHTML = `
						<div class="bg-white rounded-2xl max-w-md w-full p-6">
							<h3 class="text-lg font-bold text-slate-charcoal mb-4">
								${isRTL ? 'معلومات العميل' : 'Customer Information'}
							</h3>
							<form id="customer-form" class="space-y-4">
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">
										${isRTL ? 'الاسم' : 'Name'}
									</label>
									<input
										type="text"
										id="customer-name"
										required
										class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gulf-teal focus:border-transparent"
										placeholder="${isRTL ? 'أدخل اسمك' : 'Enter your name'}"
									>
								</div>
								<div>
									<label class="block text-sm font-medium text-gray-700 mb-2">
										${isRTL ? 'رقم الهاتف' : 'Phone Number'}
									</label>
									<input
										type="tel"
										id="customer-phone"
										required
										class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gulf-teal focus:border-transparent"
										placeholder="${isRTL ? 'أدخل رقم هاتفك' : 'Enter your phone number'}"
									>
								</div>
								<div class="flex space-x-3 pt-4">
									<button
										type="submit"
										class="flex-1 bg-gulf-teal text-white py-3 rounded-lg font-semibold hover:bg-gulf-teal/90 transition-colors"
									>
										${isRTL ? 'متابعة الطلب' : 'Checkout'}
									</button>
									<button
										type="button"
										id="cancel-button"
										class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-colors"
									>
										${isRTL ? 'إلغاء' : 'Cancel'}
									</button>
								</div>
							</form>
						</div>
					`;

					// Add to page
					document.body.appendChild(modal);

					// Focus first input
					modal.querySelector('#customer-name').focus();

					// Handle form submission
					modal.querySelector('#customer-form').addEventListener('submit', (e) => {
						e.preventDefault();
						const name = modal.querySelector('#customer-name').value.trim();
						const phone = modal.querySelector('#customer-phone').value.trim();

						if (name && phone) {
							modal.remove();
							resolve({ name, phone });
						}
					});

					// Handle cancel button
					modal.querySelector('#cancel-button').addEventListener('click', () => {
						modal.remove();
						resolve(null);
					});

					// Handle escape key
					const handleEscape = (e) => {
						if (e.key === 'Escape') {
							modal.remove();
							document.removeEventListener('keydown', handleEscape);
							resolve(null);
						}
					};
					document.addEventListener('keydown', handleEscape);
				});
			}

			// Image carousel functions
			function nextImage(button) {
				const card = button.closest('.course-card');
				const totalImages = parseInt(card.dataset.totalImages);
				if (totalImages > 1) {
					card.currentImageIndex = (card.currentImageIndex + 1) % totalImages;
					updateImageDisplay(card);
				}
			}

			function previousImage(button) {
				const card = button.closest('.course-card');
				const totalImages = parseInt(card.dataset.totalImages);
				if (totalImages > 1) {
					card.currentImageIndex = card.currentImageIndex === 0 ? totalImages - 1 : card.currentImageIndex - 1;
					updateImageDisplay(card);
				}
			}

			function setCurrentImage(button, index) {
				const card = button.closest('.course-card');
				card.currentImageIndex = index;
				updateImageDisplay(card);
			}

			function updateImageDisplay(card) {
				const images = card.querySelectorAll('.course-image');
				const indicators = card.querySelectorAll('.image-indicator');

				images.forEach((img, i) => {
					img.style.display = i === card.currentImageIndex ? 'block' : 'none';
				});

				indicators.forEach((indicator, i) => {
					if (i === card.currentImageIndex) {
						indicator.classList.add('active');
						indicator.style.backgroundColor = 'white';
					} else {
						indicator.classList.remove('active');
						indicator.style.backgroundColor = 'rgba(255,255,255,0.5)';
					}
				});
			}

			// Course card functions
			function incrementQuantity(button) {
				const card = button.closest('.course-card');
				const workshopId = card.dataset.workshopId;

				// Get selected session ID and its capacity limits
				const sessionsContainer = document.getElementById('sessions-' + workshopId);
				let selectedSessionId = '';
				let availableSeats = 0;
				if (sessionsContainer) {
					const selectedRadio = sessionsContainer.querySelector('input[type="radio"]:checked');
					if (selectedRadio) {
						selectedSessionId = selectedRadio.value;
						availableSeats = parseInt(selectedRadio.dataset.availableSeats) || 999;
					}
				}

				// If no session is selected for workshops with sessions, don't allow increment
				if (sessionsContainer && sessionsContainer.querySelectorAll('input[type="radio"]').length > 0 && !selectedSessionId) {
					alert(document.documentElement.lang === 'ar' ?
						'يرجى اختيار جلسة أولاً' :
						'Please select a session first');
					return;
				}

				// Find existing item with matching workshop ID and session ID
				const existingItem = cart.find(item => item.id === workshopId && item.sessionId === selectedSessionId);
				const currentCartQuantity = existingItem ? existingItem.quantity : 0;

				// Check if adding one more seat would exceed available capacity
				if (currentCartQuantity >= availableSeats) {
					const lang = document.documentElement.lang;
					const message = lang === 'ar' ?
						`لا يمكن إضافة المزيد، المقاعد المتاحة: ${availableSeats}` :
						`Cannot add more seats. Available seats: ${availableSeats}`;
					alert(message);
					return;
				}

				// Also check if we're at session capacity
				if (availableSeats <= 0) {
					const lang = document.documentElement.lang;
					const message = lang === 'ar' ?
						'الجلسة مكتملة' :
						'Session is full';
					alert(message);
					return;
				}

				if (existingItem) {
					// Increment existing item
					existingItem.quantity++;
				} else {
					// Create new cart item
					const cartItem = {
						id: card.dataset.workshopId,
						title: card.dataset.workshopTitle,
						price: parseFloat(card.dataset.workshopPrice),
						quantity: 1,
						sessionId: selectedSessionId,
						image: card.querySelector('.course-image[style*="block"]')?.src || '/static/images/course-placeholder.jpg'
					};
					cart.push(cartItem);
				}

				updateQuantityDisplay(card);
				updateAddToCartButton(card);
				updateCartDisplay();
				updateCartContent();
			}

			function decrementQuantity(button) {
				const card = button.closest('.course-card');
				const workshopId = card.dataset.workshopId;

				// Get selected session ID
				const sessionsContainer = document.getElementById('sessions-' + workshopId);
				let selectedSessionId = '';
				if (sessionsContainer) {
					const selectedRadio = sessionsContainer.querySelector('input[type="radio"]:checked');
					if (selectedRadio) {
						selectedSessionId = selectedRadio.value;
					}
				}

				// Find existing item with matching workshop ID and session ID
				const existingItem = cart.find(item => item.id === workshopId && item.sessionId === selectedSessionId);

				if (existingItem && existingItem.quantity > 1) {
					// Decrement existing item
					existingItem.quantity--;
					updateQuantityDisplay(card);
					updateAddToCartButton(card);
					updateCartDisplay();
					updateCartContent();
				} else if (existingItem && existingItem.quantity === 1) {
					// Remove from cart and hide quantity selector
					cart = cart.filter(item => !(item.id === workshopId && item.sessionId === selectedSessionId));
					updateCartDisplay();
					updateCartContent();

					// Hide quantity selector and reset
					const quantitySelector = card.querySelector('.quantity-selector');
					quantitySelector.style.display = 'none';
					updateQuantityDisplay(card);
					updateAddToCartButton(card);
				}
			}

			function updateQuantityDisplay(card) {
				const workshopId = card.dataset.workshopId;
				const sessionsContainer = document.getElementById('sessions-' + workshopId);
				let selectedSessionId = '';
				let currentQuantity = 1;

				if (sessionsContainer) {
					const selectedRadio = sessionsContainer.querySelector('input[type="radio"]:checked');
					if (selectedRadio) {
						selectedSessionId = selectedRadio.value;
					}
				}

				// Find the actual quantity from cart for this specific session
				const existingItem = cart.find(item => item.id === workshopId && item.sessionId === selectedSessionId);
				if (existingItem) {
					currentQuantity = existingItem.quantity;
				}

				const quantitySpan = card.querySelector('.quantity-display');
				if (quantitySpan) {
					quantitySpan.textContent = currentQuantity;
				}
			}

			function updateAddToCartButton(card) {
				const workshopId = card.dataset.workshopId;
				const sessionsContainer = document.getElementById('sessions-' + workshopId);
				let selectedSessionId = '';
				let currentQuantity = 1;

				if (sessionsContainer) {
					const selectedRadio = sessionsContainer.querySelector('input[type="radio"]:checked');
					if (selectedRadio) {
						selectedSessionId = selectedRadio.value;
					}
				}

				// Find the actual quantity from cart for this specific session
				const existingItem = cart.find(item => item.id === workshopId && item.sessionId === selectedSessionId);
				if (existingItem) {
					currentQuantity = existingItem.quantity;
				}

				const maxStudents = parseInt(card.dataset.maxStudents);
				const enrollmentCount = parseInt(card.dataset.enrollmentCount);
				const maxQuantity = maxStudents === 0 ? 999 : Math.max(0, maxStudents - enrollmentCount);
				const canAdd = currentQuantity > 0 && (maxStudents === 0 || currentQuantity <= maxQuantity);

				const button = card.querySelector('.add-to-cart-btn');
				if (button) {
					if (canAdd) {
						button.className = 'add-to-cart-btn w-full text-white py-4 px-4 rounded-xl font-semibold text-sm transition-all duration-200 flex items-center justify-center space-x-2 cart-button shadow-lg hover:shadow-xl';
						button.disabled = false;
					} else {
						button.className = 'add-to-cart-btn w-full text-white py-4 px-4 rounded-xl font-semibold text-sm transition-all duration-200 flex items-center justify-center space-x-2 bg-gray-400 cursor-not-allowed';
						button.disabled = true;
					}
				}
			}

			function addToCart(button) {
				const card = button.closest('.course-card');
				const quantitySelector = card.querySelector('.quantity-selector');
				const workshopId = card.dataset.workshopId;

				// Check for session selection if workshop has sessions
				const sessionsContainer = document.getElementById('sessions-' + workshopId);
				let selectedSessionId = '';
				let sessionAvailable = true;

				if (sessionsContainer) {
					const sessionRadios = sessionsContainer.querySelectorAll('input[type="radio"]');
					if (sessionRadios.length > 0) {
						const selectedRadio = sessionsContainer.querySelector('input[type="radio"]:checked');
						if (!selectedRadio) {
							alert(document.documentElement.lang === 'ar' ?
								'يرجى اختيار جلسة أولاً' :
								'Please select a session first');
							return;
						}
						selectedSessionId = selectedRadio.value;
						sessionAvailable = !selectedRadio.disabled;
					}
				}

				if (!sessionAvailable) {
					alert(document.documentElement.lang === 'ar' ?
						'الجلسة المحددة غير متاحة' :
						'Selected session is not available');
					return;
				}

				// Check if quantity selector is already visible
				if (quantitySelector.style.display === 'none') {
					// Show quantity selector
					quantitySelector.style.display = 'block';

					const maxStudents = parseInt(card.dataset.maxStudents);
					const enrollmentCount = parseInt(card.dataset.enrollmentCount);
					const maxQuantity = maxStudents === 0 ? 999 : Math.max(0, maxStudents - enrollmentCount);

					if (maxStudents > 0 && maxQuantity <= 0) {
						return;
					}

					// Check if item already exists in cart for this session
					const existingItem = cart.find(item => item.id === workshopId && item.sessionId === selectedSessionId);

					if (!existingItem) {
						// Get the currently displayed image
						const currentImage = card.querySelector('.course-image[style*="block"]');
						const imageSrc = currentImage ? currentImage.src : '/static/images/course-placeholder.jpg';

						const cartItem = {
							id: workshopId,
							title: card.dataset.workshopTitle,
							price: parseFloat(card.dataset.workshopPrice),
							quantity: 1,
							sessionId: selectedSessionId,
							image: imageSrc
						};

						// Add to cart
						cart.push(cartItem);
						updateCartDisplay();
						updateCartContent();
					}

					updateQuantityDisplay(card);
					updateAddToCartButton(card);
					return;
				}
			}
		</script>
	</body>
	</html>
}

// Temporarily commented out SessionOption component to fix template generation

templ CourseCard(workshop models.Workshop, lang string) {
	<div class="course-card rounded-2xl overflow-hidden shadow-lg"
		data-workshop-id={ workshop.ID.String() }
		data-max-students={ fmt.Sprintf("%d", workshop.MaxStudents) }
		data-enrollment-count={ fmt.Sprintf("%d", workshop.EnrollmentCount) }
		data-total-images={ fmt.Sprintf("%d", len(workshop.Images)) }
		data-workshop-title={ getCourseTitle(workshop, lang) }
		data-workshop-price={ fmt.Sprintf("%.2f", workshop.Price) }>

		<!-- Course Image Carousel -->
		<div class="relative h-64 overflow-hidden">
			if len(workshop.Images) > 0 {
				<!-- Multiple Images with Carousel -->
				<div class="relative h-full">
					for i, image := range workshop.Images {
						<img
							class="course-image absolute inset-0 w-full h-full object-cover transition-opacity duration-300"
							style={ fmt.Sprintf("display: %s;", func() string { if i == 0 { return "block" } else { return "none" } }()) }
							src={ image.ImageURL }
							alt={ getCourseTitle(workshop, lang) }
							onerror="this.src='/static/images/course-placeholder.jpg'"
							data-index={ fmt.Sprintf("%d", i) }
							data-is-cover={ fmt.Sprintf("%t", image.IsCover) }
						/>
					}

					<!-- Navigation Arrows (only show if multiple images) -->
					if len(workshop.Images) > 1 {
						<button
							onclick="previousImage(this)"
							class="carousel-nav-button absolute left-2 top-1/2 transform -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white rounded-full p-2 transition-all duration-200 z-10"
						>
							<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
								<path d="M15.41 16.34L10.83 11.75l4.58-4.59L14 5.75l-6 6 6 6z"/>
							</svg>
						</button>
						<button
							onclick="nextImage(this)"
							class="carousel-nav-button absolute right-2 top-1/2 transform -translate-y-1/2 bg-black/50 hover:bg-black/70 text-white rounded-full p-2 transition-all duration-200 z-10"
						>
							<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
								<path d="M8.59 16.34l4.58-4.59-4.58-4.59L10 5.75l6 6-6 6z"/>
							</svg>
						</button>

						<!-- Image Indicators -->
						<div class="absolute bottom-3 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10">
							for i := range workshop.Images {
								<button
									class="image-indicator w-2 h-2 rounded-full transition-all duration-200"
									style={ fmt.Sprintf("background-color: %s;", func() string { if i == 0 { return "white" } else { return "rgba(255,255,255,0.5)" } }()) }
									data-image-index={ fmt.Sprintf("%d", i) }
								></button>
							}
						</div>
					}
				</div>
			} else {
				<!-- Default Image -->
				<img
					src="/static/images/course-placeholder.jpg"
					alt={ getCourseTitle(workshop, lang) }
					class="w-full h-full object-cover"
					onerror="this.src='/static/images/default.jpg'"
				/>
			}
		</div>

		<!-- Course Info -->
		<div class="p-6">
			<div class="mb-4">
				<h3 class="text-lg font-bold text-slate-charcoal mb-2">
					{ getCourseTitle(workshop, lang) }
				</h3>
				<p class="text-gray-600 text-sm line-clamp-2">
					{ getCourseDescription(workshop, lang) }
				</p>
			</div>

			<!-- Price and Duration -->
			<div class="flex items-center justify-between mb-4">
				<div class="flex items-center space-x-2">
					if workshop.IsFree {
						<span class="text-2xl font-bold text-green-600">
							if lang == "ar" {
								مجاني
							} else {
								Free
							}
						</span>
					} else {
						<span class="text-2xl font-bold text-gulf-teal">{ fmt.Sprintf("%.0f", workshop.Price) }
							if lang == "ar" {
								د.ك
							} else {
								KD
							}
						</span>
					}
				</div>
				<div class="flex items-center space-x-1 text-gray-500 text-sm">
					<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
						<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 8V6h1.5v4.25l3.5 2.08-.75 1.23L12 11V10z"/>
					</svg>
					<span>{ formatDurationInHours(workshop.Duration, lang) }</span>
				</div>
			</div>


			<!-- Session Selection -->
			if len(workshop.Sessions) > 0 {
				<div class="mb-4 p-3 bg-gulf-teal/10 rounded-lg" id={ fmt.Sprintf("sessions-%s", workshop.ID.String()) }>
					<div class="flex items-center space-x-2 mb-3">
						<svg class="w-4 h-4 text-gulf-teal" fill="currentColor" viewBox="0 0 24 24">
							<path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
						</svg>
						<span class="text-sm font-medium text-gulf-teal">
							if lang == "ar" {
								اختر الجلسة
							} else {
								Select Session
							}
						</span>
					</div>

					<div class="space-y-3">
						for sessionIndex, session := range workshop.Sessions {
							if session.Status != "cancelled" && session.Status != "completed" {
								<label class="flex items-start space-x-3 p-3 bg-white rounded-lg border border-gray-200 hover:border-gulf-teal/50 transition-all cursor-pointer">
									<input
										type="radio"
										name={ fmt.Sprintf("session-%s", workshop.ID.String()) }
										value={ session.ID.String() }
										class="session-radio mt-1 w-4 h-4 text-gulf-teal border-gray-300 focus:ring-gulf-teal sr-only"
										data-max-attendees={ fmt.Sprintf("%d", session.MaxAttendees) }
										data-current-attendees={ fmt.Sprintf("%d", session.CurrentAttendees) }
										data-available-seats={ fmt.Sprintf("%d", func() int { if session.MaxAttendees == 0 { return 999 } else { return session.MaxAttendees - session.CurrentAttendees } }()) }
										data-session-dates-count={ fmt.Sprintf("%d", len(session.SessionDates)) }
										data-workshop-type={ workshop.WorkshopType }
										data-start-time={ session.StartTime }
										data-end-time={ func() string { if session.EndTime != nil { return *session.EndTime } else { return "" } }() }
										data-session-date={ session.SessionDate.Format("Jan 2, 2006") }
										data-session-dates={ func() string {
											if len(session.SessionDates) > 0 {
												dates := make([]string, len(session.SessionDates))
												for i, date := range session.SessionDates {
													dates[i] = date.Format("Jan 2, 2006")
												}
												return strings.Join(dates, "|")
											}
											return ""
										}() }
										if len(workshop.Sessions) == 1 {
											checked
										}
										if session.MaxAttendees > 0 && session.MaxAttendees - session.CurrentAttendees <= 0 {
											disabled
										}
									/>
									<div class="radio-dot w-4 h-4 mt-1 rounded-full border-2 border-gray-300 flex items-center justify-center opacity-0 transition-opacity">
										<div class="w-2 h-2 bg-gulf-teal rounded-full"></div>
									</div>
									<div class="flex-1 min-w-0">
										<div class="flex items-center justify-between">
											<div class="flex-1">
												<div class="font-medium text-gray-800 text-sm">
													if len(session.SessionDates) > 1 {
														if workshop.WorkshopType == "consecutive" {
															if lang == "ar" {
																{ fmt.Sprintf("جلسة %d:", sessionIndex + 1) }
															} else {
																{ fmt.Sprintf("Session %d:", sessionIndex + 1) }
															}
														} else {
															if lang == "ar" {
																{ fmt.Sprintf("جلسة %d:", sessionIndex + 1) }
															} else {
																{ fmt.Sprintf("Session %d:", sessionIndex + 1) }
															}
														}
													} else {
														if lang == "ar" {
															{ fmt.Sprintf("جلسة %d:", sessionIndex + 1) }
														} else {
															{ fmt.Sprintf("Session %d:", sessionIndex + 1) }
														}
													}
												</div>

												if len(session.SessionDates) > 1 && workshop.WorkshopType != "private" {
													<div class="text-xs text-gray-600 mt-1">
														if workshop.WorkshopType == "consecutive" {
															{ session.GetDateRange(lang) }
														} else {
															for dateIndex, sessionDate := range session.SessionDates {
																{ sessionDate.Format("Jan 2, 2006") }
																if dateIndex < len(session.SessionDates)-1 {
																	<br/>
																}
															}
														}
													</div>
												} else if workshop.WorkshopType != "private" {
													<div class="text-xs text-gray-600 mt-1">
														{ session.SessionDate.Format("Jan 2, 2006") }
													</div>
												}

												if workshop.WorkshopType != "private" {
													<div class="text-xs text-gray-600 mt-1">
														{ formatSessionTime(session.StartTime) }
														if session.EndTime != nil {
															- { formatSessionTime(*session.EndTime) }
														}
													</div>
												} else {
													<div class="text-xs text-blue-600 mt-1 font-medium">
														if lang == "ar" {
															متاح عند الطلب
														} else {
															Available on demand
														}
													</div>
												}

											</div>
											<div class="text-xs ml-3">
												if session.MaxAttendees > 0 {
													if session.MaxAttendees - session.CurrentAttendees <= 0 {
														<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">
															if lang == "ar" {
																مكتمل
															} else {
																Full
															}
														</span>
													} else if session.MaxAttendees - session.CurrentAttendees <= 2 {
														<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">
															{ fmt.Sprintf("%d", session.MaxAttendees - session.CurrentAttendees) }
															if lang == "ar" {
																متاح
															} else {
																left
															}
														</span>
													} else {
														<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
															if lang == "ar" {
																متاح
															} else {
																Available
															}
														</span>
													}
												} else {
													<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
														if lang == "ar" {
															متاح
														} else {
															Available
														}
													</span>
												}
											</div>
										</div>
									</div>
								</label>
							}
						}
					</div>
				</div>
			}

			<!-- Quantity Selection (hidden by default) -->
			<div class="quantity-selector mb-4" style="display: none;">
				<label class="block text-sm font-semibold text-gray-700 mb-3">
					if lang == "ar" {
						عدد المقاعد
					} else {
						Number of Seats
					}
				</label>
				<div class="flex items-center justify-center space-x-4 bg-gray-50 rounded-xl p-3">
					<button
						onclick="decrementQuantity(this)"
						class="w-10 h-10 bg-white hover:bg-gray-100 rounded-lg flex items-center justify-center transition-colors shadow-sm border border-gray-200"
					>
						<svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
							<path d="M19 13H5v-2h14v2z"/>
						</svg>
					</button>
					<div class="flex flex-col items-center">
						<span class="quantity-display text-2xl font-bold text-slate-charcoal">1</span>
						<span class="text-xs text-gray-500">
							if lang == "ar" {
								مقعد
							} else {
								seats
							}
						</span>
					</div>
					<button
						onclick="incrementQuantity(this)"
						class="w-10 h-10 bg-white hover:bg-gray-100 rounded-lg flex items-center justify-center transition-colors shadow-sm border border-gray-200"
					>
						<svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
							<path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
						</svg>
					</button>
				</div>
			</div>

			<!-- Action Button -->
			<button
				onclick="addToCart(this)"
				class="add-to-cart-btn w-full text-white py-4 px-4 rounded-xl font-semibold text-sm transition-all duration-200 flex items-center justify-center space-x-2 cart-button shadow-lg hover:shadow-xl"
			>
				<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
					<path d="M7 18c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12L8.1 13h7.45c.75 0 1.41-.41 1.75-1.03L21.7 4H5.21l-.94-2H1zm16 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
				</svg>
				<span>
					if lang == "ar" {
						أضف للسلة
					} else {
						Add to Cart
					}
				</span>
			</button>
		</div>
	</div>
}
